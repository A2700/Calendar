function toPersianDigits(num){const persianDigits=['۰','۱','۲','۳','۴','۵','۶','۷','۸','۹'];return num.toString().replace(/\d/g,digit=>persianDigits[parseInt(digit)])}const gregorianMonths=["January","February","March","April","May","June","July","August","September","October","November","December"],persianMonths=["فروردین","اردیبهشت","خرداد","تیر","مرداد","شهریور","مهر","آبان","آذر","دی","بهمن","اسفند"],months=["فروردین","اردیبهشت","خرداد","تیر","مرداد","شهریور","مهر","آبان","آذر","دی","بهمن","اسفند"],monthLengths=[31,31,31,31,31,31,30,30,30,30,30,29],daysOfWeek=["ش","ی","د","س","چ","پ","ج"];function gregorianToJalali(gy,gm,gd){let g_d_m=[0,31,59,90,120,151,181,212,243,273,304,334],jy=gy<=1600?0:979;gy-=gy<=1600?621:1600;let gy2=gm>2?gy+1:gy,days=365*gy+Math.floor((gy2+3)/4)-Math.floor((gy2+99)/100)+Math.floor((gy2+399)/400)-80+gd+g_d_m[gm-1];jy+=33*Math.floor(days/12053),days%=12053,jy+=4*Math.floor(days/1461),days%=1461,days>365&&(jy+=Math.floor((days-1)/365),days=(days-1)%365);let jm=days<186?1+Math.floor(days/31):7+Math.floor((days-186)/30),jd=1+(days<186?days%31:(days-186)%30);return[jy,jm,jd]}let holidayss={};fetch('/json/festival.json').then(response=>{if(!response.ok)throw new Error(`HTTP error! status: ${response.status}`);return response.json()}).then(data=>{holidayss=data,displayDate()});function checkHoliday(persianDay,persianMonth){const eventPersian=document.querySelector('.eventPersian');if(!eventPersian)return;const eventIcon=eventPersian.querySelector('.eventIcon');if(!eventIcon)return;if(!holidayss||Object.keys(holidayss).length===0)return eventPersian.style.display='none';const monthHolidays=holidayss[persianMonth];if(!monthHolidays||!Array.isArray(monthHolidays))return eventPersian.style.display='none';const matchingHoliday=monthHolidays.find(h=>h.day===persianDay);matchingHoliday?(eventPersian.style.display='block',eventIcon.style.backgroundImage=`url('../dist/images/fest/${matchingHoliday.image}')`,(new Image).src=`../dist/images/year/${matchingHoliday.image}`):eventPersian.style.display='none'}function displayDate(){const today=new Date,gregorianDay=today.getDate(),gregorianMonthIndex=today.getMonth(),gregorianYear=today.getFullYear(),[persianYear,persianMonthIndex,persianDay]=gregorianToJalali(gregorianYear+1300,gregorianMonthIndex+1,gregorianDay);document.getElementById("number-fa").innerHTML=`${toPersianDigits(persianDay)} ${persianMonths[persianMonthIndex-1]}`,document.getElementById("year-fa").innerHTML=toPersianDigits(persianYear),document.getElementById("number-en").innerHTML=`${gregorianDay} ${gregorianMonths[gregorianMonthIndex]}`,document.getElementById("year-en").innerHTML=gregorianYear,checkHoliday(persianDay,persianMonths[persianMonthIndex-1])}let selectedYear,selectedMonth,showingHolidays=!1;const calendarElement=document.getElementById('calendar-days'),calendarHolidayElement=document.getElementById('calendar-holiday'),calendarTitle=document.getElementById('calendar-title'),loadingElement=document.getElementById('loading'),holidayButton=document.querySelector('.holidayList .btn'),holidayListElement=document.getElementById('holiday-list');function toggleLoading(show){loadingElement.style.display=show?'flex':'none'}function isLeapYear(jy){let mod=jy%33;return[1,5,9,13,17,22,26,30].includes(mod)}function getTodayJalali(){const today=new Date;return gregorianToJalali(today.getFullYear()+1300,today.getMonth()+1,today.getDate())}function jalaliToGregorian(jy,jm,jd){let gy,gm,gd,days,sal_a=[0,31,(jy%4===3&&(jy+1)%33>=16||(jy+1)%33===0)?30:29,31,30,31,30,31,31,30,31,30,31];jy+=1595,days=-355668+365*jy+Math.floor(jy/33)*8+Math.floor((jy%33+3)/4)+jd;for(let i=0;i<jm;i++)days+=sal_a[i];gy=400*Math.floor(days/146097),days%=146097,days>36524&&(gy+=100*Math.floor(--days/36524),days%=36524,days>=365&&days++),gy+=4*Math.floor(days/1461),days%=1461,days>365&&(gy+=Math.floor((days-1)/365),days=(days-1)%365);for(gm=0;gm<12&&days>=sal_a[gm+1];gm++)days-=sal_a[gm+1];return gd=days+1,[gy,gm+1,gd]}function gregorianToJalali(gy,gm,gd){let jy,jm,jd,gy2,days,sal_a=[0,31,(gy%4===0&&gy%100!==0||gy%400===0)?29:28,31,30,31,30,31,31,30,31,30,31];gy2=gm>2?gy+1:gy,days=355666+365*gy+Math.floor((gy2+3)/4)-Math.floor((gy2+99)/100)+Math.floor((gy2+399)/400)+gd;for(let i=0;i<gm;i++)days+=sal_a[i];jy=-1595+33*Math.floor(days/12053),days%=12053,jy+=4*Math.floor(days/1461),days%=1461,days>365&&(jy+=Math.floor((days-1)/365),days=(days-1)%365);const jm_list=[0,31,62,93,124,155,186,216,246,276,306,336];for(jm=1;jm<=12&&days>=jm_list[jm];jm++);return jd=days-jm_list[jm-1]+1,[jy,jm,jd]}function applyLazyLoading(){const days=document.querySelectorAll('.calendar-table .day:not(.loaded)'),observer=new IntersectionObserver(entries=>{entries.forEach(entry=>{entry.isIntersecting&&(entry.target.classList.add('loaded'),observer.unobserve(entry.target))})},{threshold:.1});days.forEach(day=>observer.observe(day))}let holidays={};fetch('/json/holiday.json').then(response=>response.json()).then(data=>{holidays=data;const[todayY,todayM]=getTodayJalali();selectedYear=todayY,selectedMonth=todayM,renderCalendar(selectedYear,selectedMonth)}),holidayListElement.innerHTML='',window.holidayTimer&&clearInterval(window.holidayTimer);async function renderCalendar(jy,jm){toggleLoading(!0),calendarElement.innerHTML='',daysOfWeek.forEach(day=>{const el=document.createElement('div');el.classList.add('day'),el.innerText=day,calendarElement.appendChild(el)});let totalDays=monthLengths[jm-1];jm===12&&isLeapYear(jy)&&(totalDays=30);function getJalaliDayOfWeek(jy,jm,jd){const baseYear=1300,baseDayOfWeek=4,monthDays=[0,31,62,93,124,155,186,216,246,276,306,336];let daysPassed=0;for(let year=baseYear;year<jy;year++)daysPassed+=isLeapYear(year)?366:365;return daysPassed+=monthDays[jm-1],daysPassed+=jd-1,(baseDayOfWeek+daysPassed)%7}const startDay=getJalaliDayOfWeek(jy,jm,1),prevMonth=jm===1?12:jm-1,prevYear=jm===1?jy-1:jy;let prevMonthDays=monthLengths[prevMonth-1];prevMonth===12&&isLeapYear(prevYear)&&(prevMonthDays=30);const today=getTodayJalali(),monthHolidays=holidays[months[jm-1].toLowerCase()]||[],savedTasks=JSON.parse(localStorage.getItem('goalFlow'))||[];for(let i=prevMonthDays-startDay+1;i<=prevMonthDays;i++){const el=document.createElement('div');el.classList.add('day','opacity-20','prev-month'),el.textContent=toPersianDigits(i),calendarElement.appendChild(el)}holidayListElement.innerHTML='',window.holidayTimer&&(clearInterval(window.holidayTimer),window.holidayTimer=null);for(let dayCounter=1;dayCounter<=totalDays;dayCounter++){const el=document.createElement('div');el.classList.add('day'),el.textContent=toPersianDigits(dayCounter);function displayHolidays(jy,jm,dayCounter){const holidayListElement=document.getElementById('holiday-list');holidayListElement.innerHTML='';const monthHolidays=holidays[months[jm-1].toLowerCase()]||[],holiday=monthHolidays.filter(h=>h.day===dayCounter);if(holiday.length>0)if(holiday.length===1){const h=holiday[0],spanElement=document.createElement('span');spanElement.id=h.id,spanElement.textContent=h.name,holidayListElement.appendChild(spanElement),h.emoji&&((emojiSpan=document.createElement('span')).classList.add('holiday-emoji'),emojiSpan.textContent=h.emoji,holidayListElement.appendChild(emojiSpan))}else{let holidayCounter=0;const changeHolidayContent=()=>{holidayListElement.innerHTML='';const currentHoliday=holiday[holidayCounter],spanElement=document.createElement('span');spanElement.id=currentHoliday.id,spanElement.textContent=currentHoliday.name,holidayListElement.appendChild(spanElement),currentHoliday.emoji&&((emojiSpan=document.createElement('span')).classList.add('holiday-emoji'),emojiSpan.textContent=currentHoliday.emoji,holidayListElement.appendChild(emojiSpan)),holidayCounter=(holidayCounter+1)%holiday.length};changeHolidayContent(),window.holidayTimer&&clearInterval(window.holidayTimer),window.holidayTimer=setTimeout(changeHolidayContent,1e4)}}const holiday=monthHolidays.filter(h=>h.day===dayCounter);holiday.length>0&&(el.classList.add('holiday'),el.addEventListener('click',()=>{displayHolidays(jy,jm,dayCounter)})),jy===today[0]&&jm===today[1]&&dayCounter===today[2]&&(el.classList.add('current'),displayHolidays(jy,jm,dayCounter));const taskExist=savedTasks.find(t=>t.dayCounter===dayCounter&&t.jy===jy&&t.jm===jm);taskExist&&el.classList.add('todolist'),el.addEventListener('click',async()=>{const today=getTodayJalali(),taskDateObj=new Date(jy,jm-1,dayCounter),currentDate=new Date(today[0],today[1]-1,today[2]);if(taskDateObj<currentDate)return alert("نمی‌تونی توی روزهای گذشته تسک اضافه کنی!");const task=prompt("تسک امروز رو بنویس:");if(task)try{toggleLoading(!0);const todayDate=`${toPersianDigits(dayCounter)} ${months[jm-1]} ${toPersianDigits(jy)}`,newTask={taskText:task,taskDate:todayDate,dayCounter,jy,jm,isSuccess:!1};let savedTasks=JSON.parse(localStorage.getItem('goalFlow'))||[];savedTasks.push(newTask),localStorage.setItem('goalFlow',JSON.stringify(savedTasks)),document.querySelector('.timeList .flex').innerHTML='',loadTasksFromLocalStorage(),el.classList.add('todolist')}finally{toggleLoading(!1)}}),calendarElement.appendChild(el)}let totalDisplayedDays=startDay+totalDays,nextMonthDay=1;for(;totalDisplayedDays%7!==0;){const el=document.createElement('div');el.classList.add('day','opacity-20','next-month'),el.textContent=toPersianDigits(nextMonthDay++),calendarElement.appendChild(el),totalDisplayedDays++}calendarTitle.innerText=`${months[jm-1]} ${toPersianDigits(jy)}`,toggleLoading(!1),applyLazyLoading();function renderHolidays(jy,jm){calendarHolidayElement.innerHTML='';const monthHolidays=holidays[months[jm-1].toLowerCase()]||[];if(monthHolidays.length===0){const noHoliday=document.createElement('div');return noHoliday.classList.add('text-right','leading-9','text-sm','text-white'),noHoliday.textContent='مناسبتی برای این ماه نیست',calendarHolidayElement.appendChild(noHoliday)}monthHolidays.forEach(h=>{const holidayEl=document.createElement('div');holidayEl.classList.add('text-right','leading-9','text-sm','text-white','mb-1'),holidayEl.textContent=`${toPersianDigits(h.day)} - ${h.name}`,h.emoji&&((emojiSpan=document.createElement('span')).classList.add('holiday-emoji'),emojiSpan.textContent=h.emoji,holidayEl.appendChild(emojiSpan)),calendarHolidayElement.appendChild(holidayEl)})}calendarElement.style.transition='opacity 0.3s ease',calendarHolidayElement.style.transition='opacity 0.3s ease',calendarElement.style.opacity='0',calendarHolidayElement.style.opacity='0',showingHolidays?(calendarElement.style.display='none',calendarHolidayElement.style.display='block',renderHolidays(jy,jm),setTimeout(()=>{calendarHolidayElement.style.opacity='1'},10),holidayButton.textContent='جدول ماهانه'):(calendarElement.style.display='grid',calendarHolidayElement.style.display='none',setTimeout(()=>{calendarElement.style.opacity='1'},10),holidayButton.textContent='مناسبت ها'),holidayButton.addEventListener('click',()=>{showingHolidays=!showingHolidays,showingHolidays?(calendarElement.style.opacity='0',setTimeout(()=>{calendarElement.style.display='none',calendarHolidayElement.style.display='block',renderHolidays(jy,jm),setTimeout(()=>{calendarHolidayElement.style.opacity='1'},10),holidayButton.textContent='جدول ماهانه'},300)):(calendarHolidayElement.style.opacity='0',setTimeout(()=>{calendarHolidayElement.style.display='none',calendarElement.style.display='grid',setTimeout(()=>{calendarElement.style.opacity='1'},10),holidayButton.textContent='مناسبت ها'},300))});const prevMonthButton=document.getElementById('prev-month'),nextMonthButton=document.getElementById('next-month');let lastClickTime=0,clickCooldown=1e3;const lockButtons=()=>{prevMonthButton.disabled=!0,nextMonthButton.disabled=!0,prevMonthButton.style.opacity='0.3',nextMonthButton.style.opacity='0.3',prevMonthButton.style.transition='opacity 0.3s ease',nextMonthButton.style.transition='opacity 0.3s ease'},unlockButtons=()=>{prevMonthButton.disabled=!1,nextMonthButton.disabled=!1,prevMonthButton.style.opacity='1',nextMonthButton.style.opacity='1'};prevMonthButton.addEventListener('click',async()=>{const currentTime=Date.now();if(currentTime-lastClickTime<clickCooldown)return alert('لطفاً 1 ثانیه صبر کنید قبل از تغییر ماه بعدی!');lockButtons();try{jm===1?(selectedYear=jy-1,selectedMonth=12):(selectedYear=jy,selectedMonth=jm-1),toggleLoading(!0),await renderCalendar(selectedYear,selectedMonth),lastClickTime=Date.now()}finally{toggleLoading(!1),setTimeout(unlockButtons,clickCooldown)}}),nextMonthButton.addEventListener('click',async()=>{const currentTime=Date.now();if(currentTime-lastClickTime<clickCooldown)return alert('لطفاً 1 ثانیه صبر کنید قبل از تغییر ماه بعدی!');lockButtons();try{jm===12?(selectedYear=jy+1,selectedMonth=1):(selectedYear=jy,selectedMonth=jm+1),toggleLoading(!0),await renderCalendar(selectedYear,selectedMonth),lastClickTime=Date.now()}finally{toggleLoading(!1),setTimeout(unlockButtons,clickCooldown)}})}function isTaskExpired(taskDate){const taskDateParts=taskDate.split(' '),taskDay=parseInt(taskDateParts[0]),taskMonthName=taskDateParts[1],taskYear=parseInt(taskDateParts[2]),taskMonth=months.indexOf(taskMonthName)+1,taskDateObj=new Date(taskYear,taskMonth-1,taskDay),today=getTodayJalali(),currentDate=new Date(today[0],today[1]-1,today[2]);return taskDateObj<currentDate}function addTaskToUI(taskText,taskDate,dayCounter,jy,jm,isSuccess=!1){const taskListElement=document.querySelector('.timeList .flex'),noTaskMessage=document.querySelector('.notgoalFlow'),taskItem=document.createElement('div');taskItem.classList.add('task-item','relative','p-4','rounded-xl','mb-1','cursor-pointer'),taskItem.innerHTML=`<div class="icon w-12 h-12 mt-2 mr-2 float-right rounded-xl ml-4"></div><div class="title"><div class="text-base font-normal text-white">${taskText}</div><div class="time"><time class="text-xs font-light leading-9 text-white">${taskDate}</time></div></div><button class="delete-task absolute bottom-5 left-5 text-xs cursor-pointer opacity-30 hover:opacity-100 text-white" id="deletetask"><i class="fa-solid fa-trash"></i></button>`,taskListElement.appendChild(taskItem),taskItem.style.transition='transform 0.3s ease',setTimeout(()=>taskItem.style.transform='translateY(0)',0),noTaskMessage.style.display='none',isSuccess?taskItem.classList.add('opacity-30','task-success'):isTaskExpired(taskDate)&&taskItem.classList.add('opacity-20','task-end'),taskItem.addEventListener('click',e=>{if(!e.target.closest('.delete-task')){taskItem.classList.add('opacity-30','task-success'),taskItem.classList.remove('opacity-20','task-end');let savedTasks=JSON.parse(localStorage.getItem('goalFlow'))||[],taskIndex=savedTasks.findIndex(t=>t.dayCounter===dayCounter&&t.jy===jy&&t.jm===jm&&t.taskText===taskText);taskIndex!==-1&&(savedTasks[taskIndex].isSuccess=!0,localStorage.setItem('goalFlow',JSON.stringify(savedTasks)))}}),taskItem.querySelector('.delete-task').addEventListener('click',async e=>{e.stopPropagation(),toggleLoading(!0),taskItem.remove();let savedTasks=JSON.parse(localStorage.getItem('goalFlow'))||[],updatedTasks=savedTasks.filter(t=>!(t.dayCounter===dayCounter&&t.jy===jy&&t.jm===jm&&t.taskText===taskText));localStorage.setItem('goalFlow',JSON.stringify(updatedTasks)),updatedTasks.length===0&&(noTaskMessage.style.display='block');const dayElement=calendarElement.querySelector(`.day:nth-child(${dayCounter+7})`);dayElement&&(!updatedTasks.some(t=>t.dayCounter===dayCounter&&t.jy===jy&&t.jm===jm)&&dayElement.classList.remove('todolist')),toggleLoading(!1)})}function loadTasksFromLocalStorage(){const tasks=JSON.parse(localStorage.getItem('goalFlow'))||[],taskListElement=document.querySelector('.timeList .flex'),noTaskMessage=document.querySelector('.notgoalFlow');taskListElement.innerHTML='',tasks.length===0?noTaskMessage.style.display='block':(noTaskMessage.style.display='none',tasks.sort((a,b)=>a.dayCounter-b.dayCounter).forEach(task=>addTaskToUI(task.taskText,task.taskDate,task.dayCounter,task.jy,task.jm,task.isSuccess||!1)))}function resetAllTasks(){const tasks=JSON.parse(localStorage.getItem('goalFlow'))||[],noTaskMessage=document.querySelector('.notgoalFlow');if(tasks.length===0)return alert("تسکی نداری که پاک کنیم!");confirm("مطمئنی می‌خوای همه تسک‌ها رو پاک کنی؟ اگه حذف کنی قابل بازگشت نیست!")?(localStorage.removeItem('goalFlow'),document.querySelector('.timeList .flex').innerHTML='',noTaskMessage.style.display='block',document.querySelectorAll('.day.todolist').forEach(day=>day.classList.remove('todolist')),alert("همه تسک‌ها با موفقیت پاک شدن!")):alert("عملیات لغو شد.")}const resetButton=document.querySelector('.checkDone');document.getElementById('prev-month').addEventListener('click',async()=>{toggleLoading(!0),selectedMonth=selectedMonth===1?12:--selectedMonth,selectedYear=selectedMonth===12?selectedYear-1:selectedYear,await renderCalendar(selectedYear,selectedMonth),toggleLoading(!1)}),document.getElementById('next-month').addEventListener('click',async()=>{toggleLoading(!0),selectedMonth=selectedMonth===12?1:++selectedMonth,selectedYear=selectedMonth===1?selectedYear+1:selectedYear,await renderCalendar(selectedYear,selectedMonth),toggleLoading(!1)}),document.addEventListener('DOMContentLoaded',()=>{loadTasksFromLocalStorage(),resetButton.addEventListener('click',resetAllTasks)});
